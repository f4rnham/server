# Generic / temporary test for MDEV-7502 Automatic provisioning of slave
# Tested functionality of LOAD DATA FROM MASTER - transfer of table and
# database structures + table rows

--source include/have_binlog_format_mixed_or_row.inc
--source include/master-slave.inc

SET GLOBAL debug_dbug="+d,provisioning_test_running";

--connection slave
--source include/stop_slave.inc
RESET SLAVE;

# Drop pre-created database 'test' it will be provisioned from master
DROP DATABASE test;

# Create databases and tables on master + fill them with data
--connection master
RESET MASTER;

USE test;
CREATE TABLE test_1 (a int, PRIMARY KEY (a));
CREATE TABLE test_2 (a int, b int, c int, PRIMARY KEY (a));

INSERT INTO test_1 VALUES (1), (2), (3), (4), (5);
INSERT INTO test_2 VALUES (1, 1, 1), (2, 2, 2), (3, 3, 3), (4, 4, 4);

# Create table with 100 rows
CREATE TABLE big_table (a int auto_increment, PRIMARY KEY (a));
DELIMITER |;
CREATE PROCEDURE fill_big_table()
BEGIN
  DECLARE v1 INT DEFAULT 100;
  WHILE v1 > 0 DO
    INSERT big_table VALUES (NULL);
    SET v1 = v1 - 1;
  END WHILE;
END|
DELIMITER ;|
CALL fill_big_table();

CREATE DATABASE test2;
USE test2;
CREATE TABLE test2_1 (a int, PRIMARY KEY (a));
CREATE TABLE test2_2 (a int, b int, PRIMARY KEY (a));

INSERT INTO test2_1 VALUES (1), (2), (3), (4), (5);
INSERT INTO test2_2 VALUES (1, 1), (2, 2), (3, 3), (4, 4);

# Start our pseudo replication - slave will start recieving data from master
--connection slave
LOAD DATA FROM MASTER;

# Give master some time to send all data to slave - needs to be done better
sleep 1;

# Check if database and table structures were transferred
SHOW CREATE DATABASE test;
SHOW CREATE DATABASE test2;
SHOW CREATE TABLE test.test_1;
SHOW CREATE TABLE test.test_2;
SHOW CREATE TABLE test2.test2_1;
SHOW CREATE TABLE test2.test2_2;
SHOW CREATE TABLE test.big_table;

# Check if row data were transferred
SELECT * FROM test.test_1 ORDER BY a;
SELECT * FROM test.test_2 ORDER BY a;
SELECT * FROM test2.test2_1 ORDER BY a;
SELECT * FROM test2.test2_2 ORDER BY a;
SELECT * FROM test.big_table ORDER BY a;

# Cleanup
--connection master
DROP TABLE test.test_1;
DROP TABLE test.test_2;
DROP TABLE test.big_table;
DROP DATABASE test2;

SET GLOBAL debug_dbug="";

--source include/rpl_end.inc

DROP PROCEDURE test.fill_big_table;
