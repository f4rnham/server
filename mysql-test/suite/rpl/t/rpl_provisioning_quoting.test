# MDEV-7502 Automatic provisioning of slave
# Tested functionality of LOAD DATA FROM MASTER - provisioning of databases / tables
# whose names contains special characters

--source include/rpl_provisioning_init.inc

# Create databases and tables on master + fill them with data
--connection master
CREATE TABLE test.`_@_*_$_'_ _\t_\x_"_``_` (`_@_*_$_'_ _\t_\x_"_``_` int, PRIMARY KEY (`_@_*_$_'_ _\t_\x_"_``_`));
INSERT INTO test.`_@_*_$_'_ _\t_\x_"_``_` VALUES (1), (2), (3), (4), (5);

CREATE DATABASE `_@_*_$_'_ _\t_\x_"_``_`;
CREATE TABLE `_@_*_$_'_ _\t_\x_"_``_`.`select` (`where` int, PRIMARY KEY (`WHERE`));
INSERT INTO `_@_*_$_'_ _\t_\x_"_``_`.`select` VALUES (1), (2), (3), (4), (5);

CREATE DATABASE `select`;

DELIMITER |;
CREATE EVENT test.`_@_*_$_'_ _\t_\x_"_``_`
ON SCHEDULE EVERY 1024 YEAR STARTS '2038-01-19 03:14:07'
DO SELECT 1;|
DELIMITER ;|

# Start provisioning
--connection slave
LOAD DATA FROM MASTER;

# Provisioning is completed after sql thread was shut down
--source include/wait_for_slave_sql_to_stop.inc

# Check if database and table structures were transferred
SHOW CREATE TABLE test.`_@_*_$_'_ _\t_\x_"_``_`;
SHOW CREATE DATABASE `_@_*_$_'_ _\t_\x_"_``_`;
SHOW CREATE TABLE `_@_*_$_'_ _\t_\x_"_``_`.`select`;
SHOW CREATE DATABASE `select`;
SHOW CREATE EVENT test.`_@_*_$_'_ _\t_\x_"_``_`;

# Check if row data were transferred
SELECT * FROM test.`_@_*_$_'_ _\t_\x_"_``_`;
SELECT * FROM `_@_*_$_'_ _\t_\x_"_``_`.`select`;

# Cleanup
--connection master
DROP DATABASE `_@_*_$_'_ _\t_\x_"_``_`;
DROP DATABASE `select`;

--connection slave
DROP DATABASE `_@_*_$_'_ _\t_\x_"_``_`;
DROP DATABASE `select`;

--source include/rpl_provisioning_end.inc
