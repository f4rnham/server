# MDEV-7502 Automatic provisioning of slave
# Multi-master support

--source include/have_binlog_format_row.inc
--source include/have_debug.inc

--connect (slave,127.0.0.1,root,,,$SERVER_MYPORT_3)
--connect (master1,127.0.0.1,root,,,$SERVER_MYPORT_1)
--connect (master2,127.0.0.1,root,,,$SERVER_MYPORT_2)

# Setup slave
--connection slave
--replace_result $SERVER_MYPORT_1 MYPORT_1 
eval CHANGE MASTER 'master1' TO master_port=$SERVER_MYPORT_1, master_host= '127.0.0.1', master_user= 'root', master_use_gtid= slave_pos;
--replace_result $SERVER_MYPORT_2 MYPORT_2
eval CHANGE MASTER 'master2' TO master_port=$SERVER_MYPORT_2, master_host= '127.0.0.1', master_user= 'root', master_use_gtid= slave_pos;
DROP DATABASE test;

# Setup masters
--connection master1
SET GLOBAL debug_dbug= "+d,provisioning_test_running";
CREATE TABLE test.t1 (a int, PRIMARY KEY (a));
INSERT INTO test.t1 VALUES (1), (2), (3);

--connection master2
SET GLOBAL debug_dbug= "+d,provisioning_test_running";
DROP DATABASE test;
CREATE DATABASE test2;
CREATE TABLE test2.t2 (a int, PRIMARY KEY (a));
INSERT INTO test2.t2 VALUES (1), (2), (3);

# Execute load data from master
--connection slave
set default_master_connection= 'master1';
--let $master_connection= master1
--source include/load_data_from_master.inc
--source include/rpl_provisioning_wait_to_stop.inc

--connection slave
set default_master_connection= 'master2';
--let $master_connection= master2
--source include/load_data_from_master.inc
--source include/rpl_provisioning_wait_to_stop.inc

# Validate transferred data
--connection slave
SELECT * FROM test.t1;
SELECT * FROM test2.t2;

# Cleanup
DROP TABLE test.t1;
DROP DATABASE test2;
SET GLOBAL debug_dbug= "";

--connection master1
SET GLOBAL debug_dbug= "";
DROP TABLE test.t1;

--connection master2
SET GLOBAL debug_dbug= "";
DROP DATABASE test2;
CREATE DATABASE test;
