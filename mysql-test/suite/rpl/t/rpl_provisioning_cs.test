# Generic / temporary test for MDEV-7502 Automatic provisioning of slave
# Tested functionality of LOAD DATA FROM MASTER - provisioning of objects
# with special character sets and collations

--source include/rpl_provisioning_init.inc

--echo
--echo ----- Creating objects
--echo
--connection master
RESET MASTER;

USE `test`;

CREATE TABLE `t1` (a int, PRIMARY KEY (a));

DELIMITER |;

CREATE PROCEDURE `test`.`px`()
BEGIN
	SELECT CHARSET('a');
END|

CREATE FUNCTION `test`.`fx`(`str` TEXT CHARACTER SET utf8 COLLATE utf8_bin)
	RETURNS TEXT CHARACTER SET latin1 COLLATE latin1_bin
BEGIN
	SET @param_coll = COLLATION(`str`);
	RETURN `str`;
END|

CREATE TRIGGER trg1 BEFORE INSERT ON t1 FOR EACH ROW
BEGIN
  SET NEW.a = NEW.a * 2;
END|

DELIMITER ;|

SET @@local.character_set_connection= 'utf8';
SET @@local.character_set_client= 'utf8';
ALTER DATABASE test CHARACTER SET utf8 COLLATE utf8_general_ci;

DELIMITER |;

CREATE PROCEDURE `test`.`py`()
BEGIN
	SELECT CHARSET('a');
END|

CREATE FUNCTION `test`.`fy`(`str` TEXT CHARACTER SET utf8 COLLATE utf8_bin)
	RETURNS TEXT CHARACTER SET latin1 COLLATE latin1_bin
BEGIN
	SET @param_coll = COLLATION(`str`);
	RETURN `str`;
END|

CREATE TRIGGER trg2 BEFORE UPDATE ON t1 FOR EACH ROW
BEGIN
  SET NEW.a = NEW.a * 2;
END|

DELIMITER ;|

--echo
--echo ----- Show create statements from master
--echo
--exec $MYSQL test -e "SHOW CREATE PROCEDURE `test`.`px` \G"
--exec $MYSQL test -e "SHOW CREATE PROCEDURE `test`.`py` \G"
--exec $MYSQL test -e "SHOW CREATE FUNCTION `test`.`fx` \G"
--exec $MYSQL test -e "SHOW CREATE FUNCTION `test`.`fy` \G"
--exec $MYSQL test -e "SHOW CREATE TRIGGER `test`.`trg1` \G"
--exec $MYSQL test -e "SHOW CREATE TRIGGER `test`.`trg2` \G"

--echo
--echo ----- Start provisioning
--echo
--connection slave
LOAD DATA FROM MASTER;

# Provisioning is completed after sql thread was shut down
--source include/wait_for_slave_sql_to_stop.inc

--echo
--echo ----- Show create statements from slave
--echo
--exec $MYSQL test -e "SHOW CREATE PROCEDURE `test`.`px` \G"
--exec $MYSQL test -e "SHOW CREATE PROCEDURE `test`.`py` \G"
--exec $MYSQL test -e "SHOW CREATE FUNCTION `test`.`fx` \G"
--exec $MYSQL test -e "SHOW CREATE FUNCTION `test`.`fy` \G"
--exec $MYSQL test -e "SHOW CREATE TRIGGER `test`.`trg1` \G"
--exec $MYSQL test -e "SHOW CREATE TRIGGER `test`.`trg2` \G"
CALL `test`.`px`();
CALL `test`.`py`();

--echo
--echo ----- Cleanup
--echo
--connection master
DROP PROCEDURE `test`.`px`;
DROP PROCEDURE `test`.`py`;
DROP FUNCTION `test`.`fx`;
DROP FUNCTION `test`.`fy`;
ALTER DATABASE test CHARACTER SET latin1 COLLATE latin1_swedish_ci;
DROP TABLE `test`.`t1`;
SET GLOBAL debug_dbug="";

--connection slave
DROP PROCEDURE `test`.`px`;
DROP PROCEDURE `test`.`py`;
DROP FUNCTION `test`.`fx`;
DROP FUNCTION `test`.`fy`;
ALTER DATABASE test CHARACTER SET latin1 COLLATE latin1_swedish_ci;
DROP TABLE `test`.`t1`;
SET GLOBAL debug_dbug="";

--let $rpl_only_running_threads= 1
--source include/rpl_end.inc
